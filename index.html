<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <title>Roller Door Survey (PWA)</title>
  <style>
    :root { --pad: 14px; --radius: 14px; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0f172a; color: #eef2ff; }
    header { position: sticky; top: 0; background: rgba(2,6,23,0.9); backdrop-filter: blur(6px); border-bottom: 1px solid #1f2937; padding: var(--pad); display: flex; gap: 8px; align-items: center; z-index: 10; }
    header h1 { font-size: 18px; margin: 0; flex: 1; }
    main { padding: var(--pad); padding-bottom: 100px; max-width: 1100px; margin: 0 auto; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: var(--radius); margin-bottom: var(--pad); overflow: hidden; }
    .card h2 { margin: 0; padding: 12px var(--pad); font-size: 16px; background: #0b1220; border-bottom: 1px solid #1f2937; position: sticky; top: 48px; z-index: 5; }
    .section { padding: var(--pad); display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 640px) { .section { grid-template-columns: 1fr 1fr; } }
    label { display: block; font-size: 13px; color: #cbd5e1; margin-bottom: 6px; }
    input[type="text"], input[type="number"], input[type="date"], textarea, select {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #334155; background: #0b1220; color: #e5e7eb;
    }
    textarea { min-height: 70px; resize: vertical; }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .check label { display: inline; margin: 0 0 0 8px; }
    .check input { transform: scale(1.2); }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 10px 12px; border: 1px solid #1f2937; background: #0b1220; color: #e5e7eb; border-radius: 12px; cursor: pointer; }
    button.primary { background: #2563eb; border-color: #1d4ed8; }
    button.warn { background: #7c2d12; border-color: #ea580c; }
    button.ghost { background: transparent; border-color: #334155; }
    .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #334155; border-radius: 999px; }
    .footer-space { height: 70px; }
    footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(2,6,23,0.95); border-top: 1px solid #1f2937; padding: var(--pad); display: flex; gap: 8px; }
    small.muted { color: #94a3b8; }
    .hint { font-size: 12px; color: #9ca3af; }
    .required::after { content: ' *'; color: #ef4444; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .door-wrap { border: 1px dashed #334155; border-radius: 12px; padding: 10px; }
    .door-head { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .tag { border: 1px solid #334155; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Roller Door Survey</h1>
    <span id="status" class="pill">Offline-ready</span>
  </header>
  <main>
    <div class="card">
      <div class="section" style="padding-bottom: 6px;">
        <div>
          <label class="required">Job/Survey ID</label>
          <input id="survey_id" type="text" required placeholder="e.g. PO-1234 / Site code" />
        </div>
        <div>
          <label class="required">Customer / Site Name</label>
          <input id="customer_name" type="text" required placeholder="Company or site name" />
        </div>
        <div>
          <label class="required">Site Address</label>
          <textarea id="site_address" required placeholder="Street, Town, Postcode"></textarea>
        </div>
        <div class="two-col">
          <div>
            <label class="required">Surveyed By</label>
            <input id="surveyed_by" type="text" required />
          </div>
          <div>
            <label class="required">Date</label>
            <input id="date" type="date" required />
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Doors on this site</h2>
      <div class="section">
        <div class="toolbar">
          <button class="primary" onclick="addDoor()">Add Door</button>
          <button class="ghost" onclick="expandAll()">Expand all</button>
          <button class="ghost" onclick="collapseAll()">Collapse all</button>
        </div>
        <div id="doors"></div>
      </div>
    </div>

    <div class="card">
      <h2>Export</h2>
      <div class="section">
        <div class="row">
          <button class="primary" onclick="exportJSON()">Export JSON</button>
          <button onclick="exportCSV()">Export CSV</button>
          <button onclick="window.print()">Print / Save to PDF</button>
          <button class="warn" onclick="clearAll()">Clear all</button>
        </div>
        <small class="muted">Autosaves offline. Exports include all doors.</small>
      </div>
    </div>
    <div class="footer-space"></div>
  </main>

  <footer>
    <div class="toolbar">
      <button onclick="newForm()">New</button>
      <button onclick="save()">Save</button>
      <button onclick="load()">Load</button>
      <button id="installBtn" style="display:none">Install App</button>
    </div>
    <input id="save_name" placeholder="Save name (e.g. 'Acme-SiteA')" style="flex:1; padding: 10px; border-radius: 10px; border: 1px solid #334155; background:#0b1220; color:#e5e7eb;" />
  </footer>

  <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
    installBtn.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; } });

    const statusEl = document.getElementById('status');
    function setStatus(t) { statusEl.textContent = t; }
    const AUTO_KEY = 'rds_dropdowns_autosave_v1';
    const PHOTO_KEY_PREFIX = 'rds_dropdowns_photos_door_';

    const RAL = ['7016 Anthracite','9005 Jet Black','9010 Pure White','9006 Silver','6005 Moss Green','7035 Light Grey','3000 Flame Red','5010 Gentian Blue','9007 Grey Aluminium','7012 Basalt Grey','Any (type below)'];
    const GUIDE_SIZES = ['60mm','75mm','100mm','125mm','150mm'];
    const ANGLES = ['100x50x5','125x75x8','150x90x10','Other'];
    const CONTROL_PANELS = ['TS971','TS970','TS959','Other'];
    const SAFE_EDGE = ['None','8k2 Monitored','Wireless','Rubber 20mm','Rubber 30mm'];
    const PHOTOCELLS = ['None','1 set - standard','2 sets - standard','Reflective - single'];
    const MEWP = ['None','Scissor (indoor)','Scissor (outdoor)','Boom / Cherry Picker'];

    function h(tag, attrs={}, ...children) {
      const el = document.createElement(tag);
      Object.entries(attrs || {}).forEach(([k,v]) => {
        if (k === 'class') el.className = v;
        else if (k === 'style') el.style.cssText = v;
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.substring(2), v);
        else el.setAttribute(k, v);
      });
      children.flat().forEach(ch => {
        if (ch == null) return;
        if (typeof ch === 'string') el.appendChild(document.createTextNode(ch));
        else el.appendChild(ch);
      });
      return el;
    }

    function field(labelText, id, type='text', attrs={}) {
      const wrap = h('div', {});
      wrap.appendChild(h('label', {for:id}, labelText));
      const inp = h(type==='textarea'?'textarea':'input', Object.assign({id, type: type==='textarea'?'text':type}, attrs));
      wrap.appendChild(inp);
      return wrap;
    }
    function selectField(labelText, id, options, value) {
      const wrap = h('div', {});
      wrap.appendChild(h('label', {for:id}, labelText));
      const sel = h('select', {id});
      sel.appendChild(h('option', {value:''}, 'Select...'));
      options.forEach(o => sel.appendChild(h('option', {value:o, selected: value===o}, o)));
      wrap.appendChild(sel);
      return wrap;
    }
    function selectFieldInline(labelText, id, options, value) {
      const wrap = h('div', {class:'row'});
      wrap.appendChild(h('label', {for:id}, labelText));
      const sel = h('select', {id});
      sel.appendChild(h('option', {value:''}, 'Select...'));
      options.forEach(o => sel.appendChild(h('option', {value:o, selected: value===o}, o)));
      wrap.appendChild(sel);
      return wrap;
    }
    function checkbox(id, labelText, checked=false) {
      const lab = h('label', {});
      const inp = h('input', {type:'checkbox', id});
      inp.checked = !!checked;
      lab.appendChild(inp);
      lab.appendChild(document.createTextNode(' '+labelText));
      return lab;
    }
    function radio(name, value, labelText, checked=false) {
      const lab = h('label', {});
      const inp = h('input', {type:'radio', name, value});
      inp.checked = !!checked;
      lab.appendChild(inp);
      lab.appendChild(document.createTextNode(' '+labelText));
      return lab;
    }

    const doorsEl = document.getElementById('doors');
    let doors = [];

    function addDoor(prefill={}) {
      const i = doors.length;
      doors.push(prefill);
      const wrap = h('div', {class:'door-wrap', id: 'door_'+i});
      const head = h('div', {class:'door-head'},
        h('div', {}, h('strong', {}, 'Door #'+(i+1)), h('span', {class:'tag', id:'door_summary_'+i}, 'summary')),
        h('div', {class:'toolbar'},
          h('button', {class:'ghost', onclick:()=>toggleDoor(i)}, 'Toggle'),
          h('button', {class:'warn', onclick:()=>removeDoor(i)}, 'Remove')
        )
      );
      const body = h('div', {id:'door_body_'+i},
        h('div', {class:'two-col'},
          field('Opening Height (mm)', 'opening_height_'+i, 'number', {required:true, min:0, inputmode:'numeric', value:prefill.open||''}),
          field('Max Height (mm)', 'max_height_'+i, 'number', {required:true, min:0, inputmode:'numeric', value:prefill.maxh||''})
        ),
        h('div', {class:'two-col'},
          field('Headroom (auto)', 'calc_headroom_'+i, 'number', {readonly:true}),
          field('Top of Existing Plates (mm)', 'top_of_existing_plates_'+i, 'number', {min:0, inputmode:'numeric', value:prefill.top_of_existing_plates||''})
        ),
        h('div', {class:'row check'},
          h('strong',{},'Phase:'),
          radio('power_phase_'+i, 'single', 'Single', prefill.power_phase==='single'),
          radio('power_phase_'+i, 'three', 'Three', prefill.power_phase==='three'),
          radio('power_phase_'+i, 'none', 'No power', prefill.power_phase==='none'),
        ),
        h('div', {class:'row check'},
          h('strong',{},'Power feed:'),
          checkbox('power_left_'+i, 'L/HAND Power', prefill.power_left),
          checkbox('power_right_'+i, 'R/HAND Power', prefill.power_right),
        ),
        h('div', {class:'row check', id:'motor_side_row_'+i},
          h('strong',{},'Motor side:'),
          radio('motor_side_'+i, 'left', 'L/HAND Motor', prefill.motor_side==='left'),
          radio('motor_side_'+i, 'right', 'R/HAND Motor', prefill.motor_side==='right'),
        ),
        h('div', {class:'row check'},
          h('strong',{},'Drive:'),
          checkbox('drive_direct_'+i, 'Direct Drive', prefill.drive_direct),
          checkbox('drive_flange_'+i, 'Flange Mount', prefill.drive_flange),
          checkbox('drive_tube_motor_'+i, 'Tube Motor', prefill.drive_tube_motor),
          checkbox('drive_chain_'+i, 'Chain Operated', prefill.drive_chain),
          checkbox('drive_push_up_'+i, 'Push Up', prefill.drive_push_up),
        ),
        h('div', {class:'row check'},
          h('strong',{},'Type:'),
          checkbox('door_standard_rsd_'+i, 'Standard RSD', prefill.door_standard_rsd),
          checkbox('door_rapid_action_'+i, 'Rapid Action Door', prefill.door_rapid_action),
          checkbox('door_fire_'+i, 'Fire Door', prefill.door_fire),
        ),
        h('div', {class:'row check'},
          h('strong',{},'Material:'),
          checkbox('material_insulated_'+i, 'Insulated', prefill.material_insulated),
          checkbox('material_single_skin_'+i, 'Single Skin', prefill.material_single_skin),
          checkbox('material_pvc_'+i, 'PVC', prefill.material_pvc),
        ),
        selectField('Guide Size', 'guide_size_'+i, GUIDE_SIZES, prefill.guide_size),
        selectField('Angle Size', 'angle_size_'+i, ANGLES, prefill.angle_size),
        selectField('Control Panel', 'control_panel_'+i, CONTROL_PANELS, prefill.control_panel),
        selectField('Safe Edge', 'safe_edge_'+i, SAFE_EDGE, prefill.safe_edge),
        selectField('Photocells', 'photocells_'+i, PHOTOCELLS, prefill.photocells),
        h('div', {class:'row check'},
          checkbox('act_motion_sensor_'+i, 'Motion Sensor', prefill.act_motion_sensor),
          checkbox('act_remote_control_'+i, 'Remote Control', prefill.act_remote_control),
          checkbox('safety_light_curtains_'+i, 'Light Curtains', prefill.safety_light_curtains),
        ),
        field('Colour / RAL', 'colour_'+i, 'text', {placeholder:'e.g. RAL 7016', list:'ral_list', value:prefill.colour||''}),
        h('datalist', {id:'ral_list'}, ...RAL.map(r => h('option', {value:r}))),
        field('Other colour/finish', 'colour_other_'+i, 'text', {placeholder:'Free text', value:prefill.colour_other||''}),
        h('div', {class:'row check'},
          checkbox('take_down_remove_'+i, 'Take down and remove existing', prefill.take_down_remove),
          checkbox('take_down_lay_aside_'+i, 'Take down and lay aside', prefill.take_down_lay_aside),
          checkbox('hired_telehandler_'+i, 'Hired-in Telehandler required', prefill.hired_telehandler),
          selectFieldInline('MEWP', 'mewp_'+i, MEWP, prefill.mewp),
        ),
        h('div', {},
          h('label', {}, 'Photos for Door #'+(i+1)),
          h('input', {type:'file', id:'photos_'+i, accept:'image/*', multiple:true})
        ),
        h('div', {},
          h('label', {}, 'Auto-generated notes'),
          h('textarea', {id:'auto_notes_'+i, readonly:true})
        )
      );
      wrap.appendChild(head);
      wrap.appendChild(body);
      doorsEl.appendChild(wrap);
      wireDoor(i);
      updateDoorSummary(i);
      autosave();
    }

    function removeDoor(i) {
      if (!confirm('Remove this door?')) return;
      const el = document.getElementById('door_'+i);
      if (el) el.remove();
      doors[i] = null; // preserve indices for photo storage
      autosave();
    }
    function toggleDoor(i) {
      const b = document.getElementById('door_body_'+i);
      b.style.display = (b.style.display === 'none') ? '' : 'none';
    }
    function expandAll(){ doors.forEach((d, i)=>{ const b = document.getElementById('door_body_'+i); if (b) b.style.display=''; }); }
    function collapseAll(){ doors.forEach((d, i)=>{ const b = document.getElementById('door_body_'+i); if (b) b.style.display='none'; }); }

    function wireDoor(i) {
      const ids = [
        'opening_height_','max_height_','top_of_existing_plates_','colour_','colour_other_',
        'guide_size_','angle_size_','control_panel_','safe_edge_','photocells_','mewp_'
      ];
      ids.concat(['drive_direct_','drive_flange_','drive_tube_motor_','drive_chain_','drive_push_up_','door_standard_rsd_','door_rapid_action_','door_fire_','material_insulated_','material_single_skin_','material_pvc_','power_left_','power_right_']).forEach(prefix => {
        const el = document.getElementById(prefix + i);
        if (el) el.addEventListener('input', ()=>{ computeHeadroom(i); autoNotes(i); updateDoorSummary(i); autosave(); driveLogic(i); handedLogic(i); });
        if (el && el.type === 'checkbox') el.addEventListener('change', ()=>{ computeHeadroom(i); autoNotes(i); updateDoorSummary(i); autosave(); driveLogic(i); handedLogic(i); });
      });
      document.querySelectorAll('input[name="power_phase_'+i+'"], input[name="motor_side_'+i+'"]').forEach(r => {
        r.addEventListener('change', ()=>{ autoNotes(i); updateDoorSummary(i); autosave(); handedLogic(i); });
      });
      const photoInput = document.getElementById('photos_'+i);
      if (photoInput) {
        photoInput.addEventListener('change', async (e) => {
          const files = Array.from(e.target.files || []);
          const key = PHOTO_KEY_PREFIX + i;
          const existing = JSON.parse(localStorage.getItem(key) || '[]');
          for (const f of files) {
            const dataUrl = await fileToDataURL(f);
            existing.push({ name: f.name, dataUrl });
          }
          localStorage.setItem(key, JSON.stringify(existing));
          setStatus('Photos saved for door #' + (i+1));
          setTimeout(()=>setStatus('Offline-ready'), 1000);
          autosave();
        });
      }
      computeHeadroom(i); autoNotes(i); driveLogic(i); handedLogic(i);
    }

    function computeHeadroom(i) {
      const open = parseInt((document.getElementById('opening_height_'+i).value||'0'), 10);
      const maxh = parseInt((document.getElementById('max_height_'+i).value||'0'), 10);
      const hr = Math.max(0, maxh - open);
      document.getElementById('calc_headroom_'+i).value = hr || '';
    }

    function driveSelected(i) {
      return ['drive_direct_','drive_flange_','drive_tube_motor_','drive_chain_'].some(p => (document.getElementById(p+i)?.checked));
    }
    function driveLogic(i) {
      const show = driveSelected(i);
      const row = document.getElementById('motor_side_row_'+i);
      if (row) row.style.display = show ? 'flex' : 'none';
    }
    // Left/Right suggestion based on power feed
    function handedLogic(i) {
      const leftPower = document.getElementById('power_left_'+i)?.checked;
      const rightPower = document.getElementById('power_right_'+i)?.checked;
      const leftRadio = document.querySelector('input[name="motor_side_'+i+'"][value="left"]');
      const rightRadio = document.querySelector('input[name="motor_side_'+i+'"][value="right"]');
      if (leftPower && !rightPower && leftRadio && !leftRadio.checked && !rightRadio.checked) leftRadio.checked = true;
      if (rightPower && !leftPower && rightRadio && !leftRadio.checked && !rightRadio.checked) rightRadio.checked = true;
    }

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function readDoor(i) {
      const get = id => document.getElementById(id+'_'+i);
      const drive = ['drive_direct','drive_flange','drive_tube_motor','drive_chain','drive_push_up'].filter(k => get(k)?.checked).map(k=>get(k).nextSibling.textContent.trim());
      const type = ['door_standard_rsd','door_rapid_action','door_fire'].filter(k => get(k)?.checked).map(k=>get(k).nextSibling.textContent.trim());
      const material = ['material_insulated','material_single_skin','material_pvc'].filter(k => get(k)?.checked).map(k=>get(k).nextSibling.textContent.trim());
      const power_phase = (document.querySelector('input[name="power_phase_'+i+'"]:checked')||{}).value || '';
      const motor_side = (document.querySelector('input[name="motor_side_'+i+'"]:checked')||{}).value || '';
      const guide_size = get('guide_size')?.value || '';
      const angle_size = get('angle_size')?.value || '';
      const control_panel = get('control_panel')?.value || '';
      const safe_edge = get('safe_edge')?.value || '';
      const photocells = get('photocells')?.value || '';
      const colour = (get('colour')?.value || '') + (get('colour_other')?.value ? ' / '+get('colour_other').value : '');
      const open = parseInt(get('opening_height')?.value || '0', 10);
      const maxh = parseInt(get('max_height')?.value || '0', 10);
      const headroom = Math.max(0, maxh - open) || '';
      const photos = JSON.parse(localStorage.getItem(PHOTO_KEY_PREFIX + i) || '[]');
      return { drive, type, material, power_phase, motor_side, guide_size, angle_size, control_panel, safe_edge, photocells, colour, open, maxh, headroom, photos };
    }

    function autoNotes(i) {
      const v = readDoor(i);
      const parts = [];
      if (v.drive.length) parts.push(v.drive.join('/'));
      if (v.type.length) parts.push(v.type.join('/'));
      if (v.material.length) parts.push(v.material.join('/'));
      if (v.guide_size) parts.push('Guides '+v.guide_size);
      if (v.angle_size) parts.push('Angles '+v.angle_size);
      if (v.control_panel) parts.push('Panel '+v.control_panel);
      if (v.safe_edge && v.safe_edge!=='None') parts.push('Safe edge '+v.safe_edge);
      if (v.photocells && v.photocells!=='None') parts.push(v.photocells);
      if (v.colour) parts.push(v.colour);
      if (v.headroom) parts.push('Headroom '+v.headroom+'mm');
      if (v.power_phase) parts.push(v.power_phase+' phase');
      if (v.motor_side) parts.push('Motor '+v.motor_side);
      document.getElementById('auto_notes_'+i).value = parts.join(' · ');
    }

    function updateDoorSummary(i) {
      const v = readDoor(i);
      const tag = document.getElementById('door_summary_'+i);
      const bits = [];
      if (v.type.length) bits.push(v.type.join('/'));
      if (v.material.length) bits.push(v.material.join('/'));
      if (v.drive.length) bits.push(v.drive[0]);
      if (v.colour) bits.push(v.colour.split(' / ')[0]);
      if (v.open && v.maxh) bits.push(v.open+'→'+v.maxh+'mm');
      tag.textContent = bits.join(' · ') || 'summary';
    }

    function collectAll() {
      const site = {
        survey_id: document.getElementById('survey_id').value || '',
        customer_name: document.getElementById('customer_name').value || '',
        site_address: document.getElementById('site_address').value || '',
        surveyed_by: document.getElementById('surveyed_by').value || '',
        date: document.getElementById('date').value || '',
      };
      const doorsData = [];
      doors.forEach((d, i) => {
        if (d===null) return;
        doorsData.push(Object.assign({ index:i }, readDoor(i)));
      });
      return { site, doors: doorsData, saved_at: new Date().toISOString() };
    }
    function fillAll(data) {
      document.getElementById('survey_id').value = data.site?.survey_id || '';
      document.getElementById('customer_name').value = data.site?.customer_name || '';
      document.getElementById('site_address').value = data.site?.site_address || '';
      document.getElementById('surveyed_by').value = data.site?.surveyed_by || '';
      document.getElementById('date').value = data.site?.date || '';
      doors = []; doorsEl.innerHTML = '';
      (data.doors||[]).forEach(d => addDoor(d));
    }
    function autosave() {
      localStorage.setItem(AUTO_KEY, JSON.stringify(collectAll()));
      setStatus('Saved');
      setTimeout(()=>setStatus('Offline-ready'), 800);
    }
    function newForm(){ if (confirm('Clear everything?')) { localStorage.removeItem(AUTO_KEY); location.reload(); } }
    function save(){ const name = document.getElementById('save_name').value || prompt('Save name:'); if (!name) return; localStorage.setItem(AUTO_KEY+':'+name, JSON.stringify(collectAll())); setStatus('Saved "'+name+'"'); setTimeout(()=>setStatus('Offline-ready'),1200); }
    function load(){ const name = document.getElementById('save_name').value || prompt('Load name:'); if (!name) return; const raw = localStorage.getItem(AUTO_KEY+':'+name); if (!raw) { alert('No saved survey under that name.'); return; } fillAll(JSON.parse(raw)); setStatus('Loaded "'+name+'"'); setTimeout(()=>setStatus('Offline-ready'),1200); }
    function clearAll(){ if (!confirm('Clear current autosave and photos?')) return; localStorage.removeItem(AUTO_KEY); Object.keys(localStorage).filter(k=>k.startsWith(PHOTO_KEY_PREFIX)).forEach(k=>localStorage.removeItem(k)); location.reload(); }

    function exportJSON(){ const d = collectAll(); download(JSON.stringify(d,null,2), (d.site.survey_id||'survey')+'.json', 'application/json'); }
    function exportCSV(){
      const d = collectAll();
      const rows = [];
      d.doors.forEach((door, idx) => {
        rows.push({
          JobID: d.site.survey_id,
          SiteName: d.site.customer_name,
          Address: d.site.site_address,
          SurveyedBy: d.site.surveyed_by,
          Date: d.site.date,
          DoorIndex: idx+1,
          DoorType: door.type.join('/'),
          Material: door.material.join('/'),
          Drive: door.drive.join('/'),
          PowerPhase: door.power_phase,
          MotorSide: door.motor_side,
          OpeningHeight_mm: door.open,
          MaxHeight_mm: door.maxh,
          Headroom_mm: door.headroom,
          GuideSize: door.guide_size,
          AngleSize: door.angle_size,
          ControlPanel: door.control_panel,
          SafeEdge: door.safe_edge,
          Photocells: door.photocells,
          Colour: door.colour,
          MEWP: door.mewp || '',
        });
      });
      const keys = Object.keys(rows[0]||{JobID:'',SiteName:'',Address:'',SurveyedBy:'',Date:'',DoorIndex:'',DoorType:'',Material:'',Drive:'',PowerPhase:'',MotorSide:'',OpeningHeight_mm:'',MaxHeight_mm:'',Headroom_mm:'',GuideSize:'',AngleSize:'',ControlPanel:'',SafeEdge:'',Photocells:'',Colour:'',MEWP:''});
      const csv = [keys.join(','), ...rows.map(r => keys.map(k => JSON.stringify(r[k] ?? '')).join(','))].join('\n');
      download(csv, (d.site.survey_id||'survey')+'.csv', 'text/csv');
    }
    function download(content, filename, type) {
      const file = new Blob([content], {type});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(file);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
    }

    // Init
    (function init(){
      const raw = localStorage.getItem(AUTO_KEY);
      if (raw) { try { fillAll(JSON.parse(raw)); } catch(e) {} }
      if (doors.length === 0) addDoor();
      ['survey_id','customer_name','site_address','surveyed_by','date'].forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', autosave);
      });
    })();
  </script>
</body>
</html>
